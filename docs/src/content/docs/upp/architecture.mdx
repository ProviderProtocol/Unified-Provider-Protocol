---
title: Architecture
description: UPP architecture, provider model, and data flow patterns.
---

import { Aside, Badge } from '@astrojs/starlight/components';

# Architecture

<Badge text="UPP-1.3" variant="note" />

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                     Application Code                            │
└─────────────────────────────────────────────────────────────────┘
           │                    │                    │
           ▼                    ▼                    ▼
    ┌─────────────┐     ┌──────────────┐     ┌─────────────┐
    │    llm()    │     │  embedding() │     │   image()   │
    └─────────────┘     └──────────────┘     └─────────────┘
           │                    │                    │
           ▼                    ▼                    ▼
    ┌─────────────────────────────────────────────────────────────┐
    │                  Provider Adapters                          │
    └─────────────────────────────────────────────────────────────┘
                              │
                              ▼
    ┌─────────────────────────────────────────────────────────────┐
    │                    Vendor APIs                              │
    └─────────────────────────────────────────────────────────────┘
```

## Import Patterns

Implementations SHOULD export both a namespace object and individual functions:

```
// Namespace style
import ai from "upp"
claude = ai.llm({ model: anthropic("claude-sonnet-4-20250514") })

// Direct import style
import { llm } from "upp"
claude = llm({ model: anthropic("claude-sonnet-4-20250514") })
```

## Provider Structure

A provider exports a factory function that returns a `ModelReference`:

```
import openai from "upp/openai"

llm({ model: openai("gpt-4o") })
embedding({ model: openai("text-embedding-3-small") })
image({ model: openai("dall-e-3") })
```

## Separation of Concerns

| Layer | Purpose | Shared Across Modalities |
|-------|---------|--------------------------|
| **Provider Config** | Infrastructure settings | Yes |
| **Model Params** | Model behavior parameters | No |
| **Modality Options** | Interface-specific settings | No |## Provider Protocol



### ProviderConfig

All providers share common configuration:

| Field | Type | Description |
|-------|------|-------------|
| `apiKey` | String \| Function \| KeyStrategy | API key or key strategy |
| `baseUrl` | String | Override base API URL |
| `timeout` | Integer | Request timeout in milliseconds |
| `fetch` | Function | Custom fetch implementation |
| `retryStrategy` | RetryStrategy | Retry handling strategy |
| `headers` | Map&lt;String, String&gt; | Custom HTTP headers |

Providers MUST support custom headers. Custom headers MUST be merged with provider-required headers. If a custom header conflicts with a required header, the custom header SHOULD take precedence.

### Key Strategies

**KeyStrategy Interface:**

```
interface KeyStrategy {
  getKey(): String | Promise&lt;String&gt;
}
```

**Standard Implementations:**

| Strategy | Description |
|----------|-------------|
| `RoundRobinKeys(keys[])` | Cycles through keys in order |
| `WeightedKeys(entries[])` | Random selection with weights |
| `DynamicKey(fn)` | Custom async key selection |

### ModelReference

```
interface ModelReference {
  modelId: String
  provider: Provider
}
```

When a modality function receives a `ModelReference`, it MUST check if the provider supports that modality and throw `UPPError` with code `INVALID_REQUEST` if not supported.